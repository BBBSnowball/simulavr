#! @TCL_WISH@
#
#
# PS2-Keyboard and Serial-Out example for simulavrxx
#
# Last modifications:
# 02-Sep-2008 KSchwi creation of the Keyboard- / Serial TX - example
# 15-Sep-2009 KSchwi new directory structure adapted for load
#
#  $Id$
#

#set traceFile trace

#we use some itcl :-)
package require Itcl

#load the avr-simulator package
load @top_builddir@/src/.libs/libsimulavr.so
puts "simulavr loaded"

#now start external generic gui server
exec @TCL_WISH@ ../gui.tcl &

#start the trace output to given filename
#StartTrace $traceFile

#start the user interface client
set ui [new_UserInterface 7777 ]

#create new device
set dev1 [new_AvrDevice_atmega128]

#load elf file to the device
AvrDevice_Load $dev1 "./atmel_key.elf"

#set the clock cycle time [ns]. Here 4.0MHz
AvrDevice_SetClockFreq $dev1 250

#systemclock must know that this device will be stepped from application
set sc [GetSystemClock]

#also the gui updates after each cycle
$sc AddAsyncMember $ui

# create the keyboard specific nets
Net key_clk
Net key_data

# For the Atmel specifics
Net key_runLED
Net key_TestPin

# For sending the keyboard data to the display
Net key_txD0

# create the keyboard specific pins
ExtPin extKbdClk  $Pin_TRISTATE $ui "kbdClk" ".x"
ExtPin extKbdData $Pin_TRISTATE $ui "kbdData" ".x"

# These both indicators relate to AVR313 AP-Note
ExtPin extrunLED $Pin_TRISTATE $ui "runLED" ".x"
ExtPin extTestPin $Pin_TRISTATE $ui "testPin" ".x"

#ExtPin extrxD0 $Pin_TRISTATE $ui "txD0" ".x"
ExtPin exttxD0 $Pin_PULLUP $ui "txD0" ".x"

# now add the dynamic of the keyboard here :-)
Keyboard kbd $ui "kbd1" ".x"

#30..50 us is normal clocking rate so we use midrange device here :-)
Keyboard_SetClockFreq kbd 40000
$sc Add kbd

#create some nets which connect the pins
key_data Add [AvrDevice_GetPin $dev1 "D3"]
key_data Add [Keyboard_GetPin kbd "data"]
key_data Add extKbdData


key_clk Add [AvrDevice_GetPin $dev1 "D0"]
key_clk Add [Keyboard_GetPin kbd "clk"]
key_clk Add extKbdClk

key_runLED Add [AvrDevice_GetPin $dev1 "D5"]
key_runLED Add extrunLED

key_TestPin Add [AvrDevice_GetPin $dev1 "B1"]
key_TestPin Add extTestPin

SerialRx mysrx $ui "serialRx0" ".x"
SerialRxBasic_SetBaudRate mysrx 19200

key_txD0 Add [AvrDevice_GetPin $dev1 "E1"]
key_txD0 Add exttxD0
key_txD0 Add [SerialRxBasic_GetPin mysrx "rx"]
#exec xterm -e tail -f $traceFile &

puts "Simulation runs endless, please press CTRL-C to abort"

GdbServer gdb1 $dev1 1212 0
$sc Add gdb1

exec @DDD_WITH_ARGS@ avr-gdb --command @srcdir@/checkdebug.gdb &

#now run simulation
$sc Endless

